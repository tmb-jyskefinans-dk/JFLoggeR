<div class="rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 shadow-sm p-6 text-slate-700 dark:text-slate-200">
  @if(toast()) {
    <div class="fixed bottom-4 right-4 z-50 select-none">
      <div class="rounded-md bg-slate-900/90 dark:bg-slate-900 text-white px-4 py-2 text-xs shadow-lg flex items-center gap-2 animate-fade-in" role="status" aria-live="polite">
        <svg class="w-3.5 h-3.5 opacity-70" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M13 16h-1v-4h-1"/><path d="M12 8h.01"/><circle cx="12" cy="12" r="10"/></svg>
        <span>{{toast()}}</span>
      </div>
    </div>
  }
  <!-- Top toolbar with navigation and charts -->
  <div class="flex flex-col gap-6">
    <div class="flex items-center gap-2 flex-wrap">
      <h2 class="text-lg font-semibold tracking-tight dark:text-slate-100 flex items-center gap-2">
        <span>Opsummering</span>
        <span class="px-2 py-0.5 rounded-md bg-indigo-50 text-indigo-700 dark:bg-indigo-500/20 dark:text-indigo-200 text-sm font-medium" aria-label="Valgt dag">{{day()}}</span>
      </h2>
      <div class="flex items-center gap-2 ml-auto" aria-label="Dagnavigation" role="group">
        <label class="sr-only" for="dayPicker">Vælg dag</label>
        <input id="dayPicker" type="date" class="rounded-md border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 px-2 h-8 text-xs focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-400" [value]="day()" [max]="day()" (change)="gotoDay($event.target.value)" aria-label="Vælg dato" />
        <button type="button" (click)="gotoDay(prevDay())" [disabled]="!prevDay()" class="inline-flex items-center gap-1 rounded-md px-3 h-8 text-xs font-medium border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 hover:bg-slate-100 dark:hover:bg-slate-600 disabled:cursor-not-allowed disabled:opacity-40 disabled:bg-slate-100 disabled:text-slate-400 dark:disabled:bg-slate-800 dark:disabled:text-slate-500 focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-400" aria-label="Forrige dag" title="Forrige dag (Pil venstre)">←</button>
        <button type="button" (click)="gotoToday()" [disabled]="isToday()" class="inline-flex items-center gap-1 rounded-md px-3 h-8 text-xs font-medium border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 hover:bg-slate-100 dark:hover:bg-slate-600 disabled:cursor-not-allowed disabled:opacity-40 disabled:bg-slate-100 disabled:text-slate-400 dark:disabled:bg-slate-800 dark:disabled:text-slate-500 focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-400" aria-label="Gå til i dag" title="I dag (T)">I dag</button>
        <button type="button" (click)="gotoDay(nextDay())" [disabled]="!nextDay()" class="inline-flex items-center gap-1 rounded-md px-3 h-8 text-xs font-medium border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 hover:bg-slate-100 dark:hover:bg-slate-600 disabled:cursor-not-allowed disabled:opacity-40 disabled:bg-slate-100 disabled:text-slate-400 dark:disabled:bg-slate-800 dark:disabled:text-slate-500 focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-400" aria-label="Næste dag" title="Næste dag (Pil højre)">→</button>
        <button (click)="exportExcel()" class="inline-flex items-center gap-1 rounded-md bg-emerald-600 hover:bg-emerald-500 active:bg-emerald-700 text-white text-xs font-semibold px-3 h-8 shadow focus:outline-none focus-visible:ring-2 focus-visible:ring-emerald-400" aria-label="Exportér opsummering til Excel" [disabled]="!rows().length">
          <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M4 4h16v4H4z"/><path d="M4 12h16v8H4z"/><path d="M4 4v16"/><path d="M10 8v8"/><path d="M14 8v8"/><path d="M4 12h16"/></svg>
          <span>Export</span>
        </button>
      </div>
    </div>
    <!-- Charts moved to top -->
    @if(categoryChartData().length) {
      <div class="grid gap-6 lg:grid-cols-[200px_minmax(0,1fr)]" aria-label="Grafisk oversigt">
        <!-- Donut chart column (fixed width) -->
        <div class="flex flex-col lg:col-span-1 pr-2 h-full justify-center">
          <figure class="flex flex-col items-start gap-2" aria-label="Donutdiagram kategori minutter">
            <svg class="" viewBox="0 0 140 140" width="160" height="160" role="img" aria-labelledby="donutTitle donutDesc">
              <title id="donutTitle">Kategori minutter</title>
              <desc id="donutDesc">Fordeling af loggede minutter per kategori for valgt dag</desc>
              <circle cx="70" cy="70" r="54" fill="none" stroke="var(--tw-color-slate-300,var(--tw-prose-body))" stroke-width="18" opacity="0.25"></circle>
              @for(seg of donutSegments(); track seg.category) {
                <circle cx="70" cy="70" r="54" fill="none" [attr.stroke]="seg.color" stroke-width="18" stroke-linecap="butt"
                  [attr.stroke-dasharray]="(animateDonut() ? (seg.length + ' ' + (circumference - seg.length)) : ('0 ' + circumference))"
                  [attr.stroke-dashoffset]="-seg.offset" opacity="0.95" class="donut-seg"
                  tabindex="0"
                  [attr.aria-label]="(seg.category || 'Ingen kategori') + ': ' + seg.minutes + ' min (' + (seg.percent|number:'1.0-1') + '%)'">
                  <title>{{seg.category || 'Ingen kategori'}}: {{seg.minutes}} min ({{seg.percent|number:'1.0-1'}}%)</title>
                </circle>
              }
            </svg>
            <figcaption class="text-xs text-slate-500 dark:text-slate-400">Total: {{totalMinutes()}} min</figcaption>
          </figure>
          <!-- Donut legend deliberately removed per request (labels excluded) -->
        </div>
  <!-- Horizontal bar chart expanded column -->
  <div class="lg:col-span-1">
          <h3 class="text-sm font-semibold tracking-tight text-slate-600 dark:text-slate-300 mb-3">Kategori fordeling (minutter)</h3>
          <div class="space-y-2" role="group" aria-label="Horisontal søjlediagram over minutter pr. kategori">
            @for(c of categoryChartData(); track c.category) {
              <div class="flex items-center gap-2">
       <div class="w-56 truncate text-[11px] font-medium" [style.color]="c.color"
         [attr.title]="c.category || 'Ingen kategori'"
         [attr.aria-label]="c.category || 'Ingen kategori'">{{c.category || 'Ingen'}}</div>
                <div class="flex-1 h-3 rounded bg-slate-200 dark:bg-slate-700 overflow-hidden" aria-hidden="true">
                  <div class="h-full bar-fill" [style.background]="c.color" [style.width.%]="animateBars() ? c.percent : 0" title="{{c.minutes}} min ({{c.percent|number:'1.0-1'}}%)" tabindex="0" [attr.aria-label]="c.category + ' bar: ' + c.minutes + ' minutter (' + (c.percent|number:'1.0-1') + '%)'"></div>
                </div>
       <div class="w-32 text-right text-[11px] text-slate-600 dark:text-slate-300"
         [attr.title]="(c.minutes + ' min (' + (c.percent|number:'1.0-1') + '%)')"
         [attr.aria-label]="(c.minutes + ' minutter (' + (c.percent|number:'1.0-1') + '%)')">{{c.minutes}} min ({{c.percent|number:'1.0-1'}}%)</div>
              </div>
            }
          </div>
        </div>
      </div>
    }
  </div>
  <div class="overflow-auto mt-6">
      @if(rootGroupTotals().length) {
        <div class="mb-6">
          <h3 class="text-sm font-semibold tracking-tight text-slate-600 dark:text-slate-300 mb-3">Root kategorier</h3>
          <div class="space-y-4" aria-label="Root kategorier oversigt">
            @for(g of rootGroupTotals(); track g.label) {
              <section class="rounded-lg border border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-700/30 p-4">
                <header class="flex items-center justify-between mb-2">
                  <h4 class="text-xs font-semibold uppercase tracking-wide text-slate-600 dark:text-slate-300">{{g.label}}</h4>
                  <span class="text-xs font-semibold text-indigo-600 dark:text-indigo-300">{{g.minutes}} min • {{g.slots}} intervaller</span>
                </header>
                <ul class="grid gap-2 sm:grid-cols-2 lg:grid-cols-3" aria-label="Underkategorier for {{g.label}}">
                  @for(child of g.children; track child.category) {
                    <li class="rounded-md border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-800/40 p-3 flex flex-col gap-1">
                      <div class="flex items-center justify-between">
                        <span class="text-[11px] font-medium text-slate-700 dark:text-slate-200">{{child.category || 'Ingen kategori'}}</span>
                        <span class="text-[11px] text-indigo-600 dark:text-indigo-300 font-semibold">{{child.minutes}} min</span>
                      </div>
                      <div class="text-[10px] text-slate-500 dark:text-slate-400">{{child.slots}} intervaller</div>
                      <div class="h-1 rounded bg-slate-200 dark:bg-slate-600 overflow-hidden" aria-hidden="true">
                        <div class="h-full bar-fill" [style.background]="getColor(child.category)" [style.width.%]="animateBars() ? ((child.minutes/totalMinutes())*100) : 0" tabindex="0" [attr.aria-label]="child.category + ' bar: ' + child.minutes + ' minutter'" title="{{child.minutes}} min"></div>
                      </div>
                    </li>
                  }
                </ul>
              </section>
            }
          </div>
        </div>
      }
    <table class="min-w-full text-sm" aria-describedby="summaryTotals" aria-label="Work slot summary table">
  <caption class="text-left text-sm text-slate-500 dark:text-slate-400 mb-2">Samlet oversigt over arbejdsslots for {{day()}}</caption>
      <thead class="text-slate-600 dark:text-slate-300">
        <tr>
          <th scope="col" class="text-left py-2">Beskrivelse</th>
          <th scope="col" class="text-left">Kategori</th>
          <th scope="col" class="text-left">Intervaller</th>
          <th scope="col" class="text-left">Minutter</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-slate-200 dark:divide-slate-700">
        @if(loading()) {
          @for(i of [1,2,3,4]; track i) {
            <tr>
              <td class="py-2"><div class="h-4 w-40 rounded bg-slate-200 dark:bg-slate-700 animate-pulse" aria-hidden="true"></div><span class="sr-only">Indlæser beskrivelse…</span></td>
              <td><div class="h-4 w-24 rounded bg-slate-200 dark:bg-slate-700 animate-pulse" aria-hidden="true"></div><span class="sr-only">Indlæser kategori…</span></td>
              <td><div class="h-4 w-10 rounded bg-slate-200 dark:bg-slate-700 animate-pulse" aria-hidden="true"></div><span class="sr-only">Indlæser intervaller…</span></td>
              <td><div class="h-4 w-14 rounded bg-slate-200 dark:bg-slate-700 animate-pulse" aria-hidden="true"></div><span class="sr-only">Indlæser minutter…</span></td>
            </tr>
          }
        } @else {
          @for(s of rows(); track s.minutes) {
          <tr class="transition-colors hover:bg-indigo-50 dark:hover:bg-slate-700/60 hover:text-slate-900 dark:hover:text-slate-50">
            <th scope="row" class="py-2 font-medium text-left">{{s.description}}</th>
            <td>{{s.category}}</td>
            <td class="text-slate-600 dark:text-slate-300">{{s.slots}}</td>
            <td class="text-slate-600 dark:text-slate-300">{{s.minutes}}</td>
          </tr>
          }
        }
      </tbody>
      @if(rows().length) {
        <tfoot class="text-slate-700 dark:text-slate-200">
          <tr id="summaryTotals" class="border-t border-slate-300 dark:border-slate-600">
            <th scope="row" class="py-2 font-semibold text-left" colspan="2">Totaler</th>
            <td class="font-semibold">{{totalSlots()}}</td>
            <td class="font-semibold">{{totalMinutes()}}</td>
          </tr>
        </tfoot>
      }
    </table>
  </div>
  @if(!loading() && !rows().length) {
    <div class="mt-6 text-sm text-slate-500 dark:text-slate-400 flex items-center gap-2" role="status" aria-live="polite">
      <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
  Ingen opsummeringsposter endnu for denne dag.
    </div>
  }
</div>
